<!DOCTYPE html>
<html lang="en" class="dark-theme">

<script>
const GEMINI_API_KEY = "";
let lastUserInput = "";
const coursesMap = {};
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PATH Compass</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #9d4edd;
            --primary-dark: #7b2cbf;
            --bg-color: #10002b;
            --card-bg: rgba(22, 3, 48, 0.85);
            --text-color: #e0e0e0;
            --border-color: rgba(157, 78, 221, 0.3);
            --accent-color: #ff3333;
            --accent-dark: #cc0000;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-color), #240046) fixed;
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
        }
        h1 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
            font-weight: 800;
            text-align: center;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(157, 78, 221, 0.5);
            letter-spacing: 1px;
            animation: titleAnimation 1.5s ease-out forwards;
            transform-origin: center;
        }
        
        @keyframes titleAnimation {
            0% {
                opacity: 0;
                transform: translateY(-50px) scale(0.8);
                letter-spacing: -5px;
            }
            30% {
                opacity: 1;
                transform: translateY(10px) scale(1.1);
                letter-spacing: 3px;
            }
            60% {
                transform: translateY(-7px) scale(0.95);
                letter-spacing: 1px;
            }
            80% {
                transform: translateY(3px) scale(1.02);
            }
            100% {
                transform: translateY(0) scale(1);
                letter-spacing: 1px;
            }
        }
        
        .title-highlight {
            color: var(--accent-color);
            position: relative;
            display: inline-block;
        }
        
        .title-highlight::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transform-origin: left;
            animation: underlineAnimation 1.8s ease-out 0.8s forwards;
        }
        
        @keyframes underlineAnimation {
            0% {
                transform: scaleX(0);
            }
            100% {
                transform: scaleX(1);
            }
        }
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(157, 78, 221, 0.25);
            color: var(--text-color);
        }
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .importance-container {
            position: relative;
            padding: 10px;
            border-radius: 10px;
            background: rgba(157, 78, 221, 0.1);
            margin-top: 5px;
        }
        .importance-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: white;
            z-index: 10;
        }
        .form-range {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            width: calc(100% - 50px);
            margin-right: 50px;
        }
        .form-range::-webkit-slider-thumb {
            background: var(--primary-color);
            border: 2px solid rgba(255, 255, 255, 0.5);
            height: 20px;
            width: 20px;
            margin-top: -7px;
            transition: all 0.2s ease;
        }
        .form-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        .section-title {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.2rem;
            position: relative;
            display: inline-block;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        .course-details {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        .course-details li {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background: rgba(157, 78, 221, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .course-details strong {
            color: var(--primary-color);
        }
        .course-details .value {
            background: rgba(157, 78, 221, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
            color: var(--text-color);
            padding: 12px 30px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            margin-top: 2rem;
            box-shadow: 0 4px 15px rgba(123, 44, 191, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(123, 44, 191, 0.5);
        }
        .result-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(var(--primary-color) 0%, var(--primary-color) 0%, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
            position: relative;
            box-shadow: 0 0 30px rgba(157, 78, 221, 0.3);
            transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .result-circle::before {
            content: '';
            width: 180px;
            height: 180px;
            background: var(--card-bg);
            border-radius: 50%;
            position: absolute;
            backdrop-filter: blur(5px);
        }
        .result-circle::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                transparent 0,
                var(--primary-color) 0,
                var(--primary-color) var(--percentage),
                transparent var(--percentage)
            );
            mask: radial-gradient(transparent 65%, black 66%);
            -webkit-mask: radial-gradient(transparent 65%, black 66%);
            animation: rotate 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0.3;
        }
        @keyframes rotate {
            from {
                transform: rotate(-90deg);
            }
            to {
                transform: rotate(0deg);
            }
        }
        .result-text {
            position: relative;
            z-index: 1;
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(157, 78, 221, 0.5);
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .result-circle.animate .result-text {
            opacity: 1;
            transform: scale(1);
        }
        .result-circle .percentage-label {
            position: absolute;
            bottom: 45px;
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .result-circle.animate .percentage-label {
            opacity: 0.7;
            transform: translateY(0);
        }
        .result-circle .match-label {
            position: absolute;
            top: 45px;
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-color);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .result-circle.animate .match-label {
            opacity: 0.7;
            transform: translateY(0);
        }
        .comparison-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .comparison-table table {
            margin: 0;
            color: var(--text-color);
        }
        .comparison-table th {
            background: rgba(157, 78, 221, 0.3) !important;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            padding: 1rem;
            border: none;
        }
        .comparison-table tr {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .comparison-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }
        .comparison-table td {
            padding: 1rem;
            vertical-align: middle;
            color: var(--text-color);
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .comparison-table tr:hover {
            background: rgba(157, 78, 221, 0.1);
            transition: background 0.2s ease;
        }
        .comparison-table .value {
            background: rgba(157, 78, 221, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            color: white;
        }
        /* Override Bootstrap table styles */
        .table {
            --bs-table-bg: transparent;
            --bs-table-color: var(--text-color);
            --bs-table-border-color: rgba(255, 255, 255, 0.05);
            margin: 0;
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(157, 78, 221, 0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(157, 78, 221, 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(157, 78, 221, 0.5);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            color: var(--text-color);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .input-group-text {
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }
        .ratio-inputs {
            display: flex;
            gap: 10px;
        }
        .ratio-inputs .form-control {
            text-align: center;
        }
        .ratio-label {
            text-align: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            min-height: 42px;
            align-items: center;
            cursor: text;
        }
        .tag-container:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(157, 78, 221, 0.25);
        }
        .tag-input {
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-color);
            flex: 1;
            min-width: 120px;
            padding: 4px 0;
        }
        .tag-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .tag {
            display: inline-flex;
            align-items: center;
            background: rgba(157, 78, 221, 0.2);
            color: var(--text-color);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            gap: 6px;
            transition: all 0.2s ease;
        }
        .tag:hover {
            background: rgba(157, 78, 221, 0.3);
        }
        .remove-tag {
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0 2px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .remove-tag:hover {
            color: #ff6b6b;
            transform: scale(1.1);
        }
        .course-matches {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .course-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
            text-align: left;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(157, 78, 221, 0.3);
        }
        .course-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
        }
        .course-card h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .course-header h4 {
            margin-bottom: 0;
        }
        .match-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            background: rgba(157, 78, 221, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            text-shadow: 0 0 10px rgba(255, 51, 51, 0.3);
        }
        .course-score {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0;
            text-shadow: 0 0 10px rgba(157, 78, 221, 0.3);
        }
        .course-details-btn {
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .course-details-btn:hover {
            background: rgba(157, 78, 221, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(157, 78, 221, 0.3);
        }
        .course-info {
            margin: 15px 0;
            font-size: 0.9rem;
        }
        .course-info div {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        .course-info .label {
            color: rgba(255, 255, 255, 0.7);
        }
        .course-info .value {
            font-weight: 500;
        }
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
        }
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            background: rgba(157, 78, 221, 0.1);
        }
        .modal-header .modal-title {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
            font-weight: 600;
        }
        .modal-footer {
            border-top: 1px solid var(--border-color);
            background: rgba(157, 78, 221, 0.05);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        /* Custom dark theme alert */
        .alert-dark-info {
            background: rgba(157, 78, 221, 0.15);
            color: var(--text-color);
            border: 1px solid rgba(157, 78, 221, 0.3);
            border-radius: 10px;
            padding: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-5">
            <span class="title-highlight">PATH</span> Compass
        </h1>
    
    <!-- New Gemini Smart Preference Setter Section -->
    <div id="gemini-input-section" class="mb-4">
      <h3 class="section-title">Smart Preference Setter</h3>
      <p class="text-light">Type your course preference in natural language and click "Set Preferences" to auto-fill the form fields. Note, however, that unmentioned parameters will be set to a 0% weighting.</p>
    <div class="input-group">
  <input type="text" id="geminiInput" class="form-control" placeholder="e.g. I just want to pass" 
         style="padding: 12px 15px; min-height: 50px;">
  <button id="geminiSend" class="btn btn-primary" 
          style="min-height: 50px; display: flex; align-items: center; justify-content: center; padding: 0.375rem 0.75rem; border-radius: 0.375rem; margin-left: 0.5rem; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border: none; box-shadow: 0 4px 15px rgba(123, 44, 191, 0.2); margin-top: 0;">
    Set Preferences
  </button>
</div>
    </div>
        
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="mb-4">
          <h3 class="section-title">Course Data</h3>
          <div class="alert-dark-info">
            Course data is automatically loaded from the database.
                    </div>
                </div>

                <form id="matchForm">
                    <h3 class="section-title">Your Preferences</h3>
                    <p class="text-light mb-4">Adjust your preferences and their importance below</p>

                    <!-- Column Headers -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong class="form-label">Parameter</strong>
                        </div>
                        <div class="col-md-5">
                            <strong class="form-label">Value</strong>
                        </div>
                        <div class="col-md-4">
                            <strong class="form-label">Weighting</strong>
                        </div>
                    </div>

                    <!-- Pass Rate -->
                    <div class="form-group">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Pass Rate</label>
                            </div>
                            <div class="col-md-5">
                                <select name="pass_rate" class="form-select">
                                    <option value="Low">Low (< 60%)</option>
                                    <option value="Medium">Medium (60-80%)</option>
                                    <option value="High" selected>High (> 80%)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="importance-container">
                                    <input type="range" class="form-range importance-slider" name="care_pass_rate" min="0" max="100" step="5" value="80">
                                    <span class="importance-value">80%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Ratio -->
                    <div class="form-group">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Assessment Distribution</label>
                            </div>
                            <div class="col-md-5">
                                <div class="ratio-inputs">
                                    <div class="flex-grow-1">
                                        <input type="number" class="form-control ratio-input" data-index="0" min="0" max="100" value="60">
                                        <div class="ratio-label">Exam %</div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <input type="number" class="form-control ratio-input" data-index="1" min="0" max="100" value="30">
                                        <div class="ratio-label">Individual %</div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <input type="number" class="form-control ratio-input" data-index="2" min="0" max="100" value="10">
                                        <div class="ratio-label">Group %</div>
                                    </div>
                                </div>
                                <input type="hidden" name="assessment_ratio" value="0.6:0.3:0.1">
                            </div>
                            <div class="col-md-4">
                                <div class="importance-container">
                                    <input type="range" class="form-range importance-slider" name="care_assessment_ratio" min="0" max="100" step="5" value="70">
                                    <span class="importance-value">70%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Number of Assessments -->
                    <div class="form-group">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Number of Assessments</label>
                            </div>
                            <div class="col-md-5">
                                <input type="number" class="form-control" name="num_assessments" value="5" min="1" max="20">
                            </div>
                            <div class="col-md-4">
                                <div class="importance-container">
                                    <input type="range" class="form-range importance-slider" name="care_num_assessments" min="0" max="100" step="5" value="40">
                                    <span class="importance-value">40%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructor Rating -->
                    <div class="form-group">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Instructor Rating</label>
                            </div>
                            <div class="col-md-5">
                                <div class="input-group">
                                    <span class="input-group-text">></span>
                                    <input type="number" class="form-control" name="instructor_rating" value="80" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="importance-container">
                                    <input type="range" class="form-range importance-slider" name="care_instructor_rating" min="0" max="100" step="5" value="90">
                                    <span class="importance-value">90%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Topics -->
                    <div class="form-group">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Topics of Interest</label>
                            </div>
                            <div class="col-md-5">
                                <div class="tag-container" id="topicsContainer">
                                    <input type="text" class="tag-input" placeholder="Type and press Enter to add topic">
                                </div>
                                <input type="hidden" name="topics" value="AI; Machine Learning">
                            </div>
                            <div class="col-md-4">
                                <div class="importance-container">
                                    <input type="range" class="form-range importance-slider" name="care_topics" min="0" max="100" step="5" value="60">
                                    <span class="importance-value">60%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Strengths -->
                    <div class="form-group">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Assessment Strengths</label>
                            </div>
                            <div class="col-md-5">
                                <div id="strengthsContainer">
                                    <div class="assessment-strength">
                                        <select class="form-select strength-type">
                                            <option value="exam">Exam</option>
                                            <option value="individual work">Individual Work</option>
                                            <option value="group work">Group Work</option>
                                        </select>
                                        <div class="input-group">
                                            <input type="number" class="form-control strength-value" min="0" max="100" value="90">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addStrength">
                                    <i class="fas fa-plus"></i> Add Assessment Type
                                </button>
                                <input type="hidden" name="assessment_strengths" value="exam:0.9,individual work:0.7">
                            </div>
                            <div class="col-md-4">
                                <div class="importance-container">
                                    <input type="range" class="form-range importance-slider" name="care_assessment_strengths" min="0" max="100" step="5" value="50">
                                    <span class="importance-value">50%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Popularity -->
                    <div class="form-group">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Popularity</label>
                            </div>
                            <div class="col-md-5">
                                <select name="popularity" class="form-select">
                                    <option value="Low">Low (< 40%)</option>
                                    <option value="Medium" selected>Medium (40-70%)</option>
                                    <option value="High">High (> 70%)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="importance-container">
                                    <input type="range" class="form-range importance-slider" name="care_popularity" min="0" max="100" step="5" value="20">
                                    <span class="importance-value">20%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gender Distribution -->
                    <div class="form-group">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Gender Distribution</label>
                            </div>
                            <div class="col-md-5">
                                <div class="ratio-inputs">
                                    <div class="flex-grow-1">
                                        <input type="number" class="form-control gender-ratio" data-index="0" min="0" max="100" value="50">
                                        <div class="ratio-label">Male %</div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <input type="number" class="form-control gender-ratio" data-index="1" min="0" max="100" value="50">
                                        <div class="ratio-label">Female %</div>
                                    </div>
                                </div>
                                <input type="hidden" name="gender_distribution" value="50:50">
                            </div>
                            <div class="col-md-4">
                                <div class="importance-container">
                                    <input type="range" class="form-range importance-slider" name="care_gender_distribution" min="0" max="100" step="5" value="70">
                                    <span class="importance-value">70%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Calculate Match</button>
                </form>

                <div id="result" class="mt-5 text-center" style="display: none;">
                    <h3 class="section-title">Course Matches</h3>
                    <div class="course-matches">
                        <!-- Course match cards will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
    // Update importance slider display on input
        document.querySelectorAll('.importance-slider').forEach(slider => {
            const valueDisplay = slider.parentNode.querySelector('.importance-value');
            slider.addEventListener('input', (e) => {
                valueDisplay.textContent = `${e.target.value}%`;
            });
        });

        // Handle assessment ratio inputs
        document.querySelectorAll('.ratio-input').forEach(input => {
            input.addEventListener('input', () => {
                const inputs = document.querySelectorAll('.ratio-input');
                const values = Array.from(inputs).map(i => parseInt(i.value) || 0);
                const total = values.reduce((a, b) => a + b, 0);
                if (total === 100) {
                    const ratios = values.map(v => (v / 100).toFixed(1));
                    document.querySelector('[name="assessment_ratio"]').value = ratios.join(':');
                }
            });
        });

        // Handle gender ratio inputs
        document.querySelectorAll('.gender-ratio').forEach(input => {
            input.addEventListener('input', (e) => {
                const inputs = document.querySelectorAll('.gender-ratio');
                const currentInput = e.target;
                const currentValue = parseInt(currentInput.value) || 0;
                const otherInput = Array.from(inputs).find(i => i !== currentInput);
                
                // Ensure value is between 0 and 100
                if (currentValue < 0) currentInput.value = 0;
                if (currentValue > 100) currentInput.value = 100;
                
                // Update the other input to make sum 100
                if (otherInput) {
                    otherInput.value = 100 - currentValue;
                }
                
                // Update the hidden field
                const values = Array.from(inputs).map(i => parseInt(i.value) || 0);
                document.querySelector('[name="gender_distribution"]').value = values.join(':');
            });
        });

        // Handle assessment strengths
        function updateAssessmentStrengths() {
            const container = document.getElementById('strengthsContainer');
            const strengths = Array.from(container.querySelectorAll('.assessment-strength')).map(div => {
                const type = div.querySelector('.strength-type').value;
                const value = (parseInt(div.querySelector('.strength-value').value) || 0) / 100;
                return `${type}:${value.toFixed(1)}`;
            });
            document.querySelector('[name="assessment_strengths"]').value = strengths.join(",");
        }
        document.getElementById('addStrength').addEventListener('click', () => {
            const div = document.createElement('div');
            div.className = 'assessment-strength';
            div.innerHTML = `
                <select class="form-select strength-type">
                    <option value="exam">Exam</option>
                    <option value="individual work">Individual Work</option>
                    <option value="group work">Group Work</option>
                </select>
                <div class="input-group">
                    <input type="number" class="form-control strength-value" min="0" max="100" value="90">
                    <span class="input-group-text">%</span>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove(); updateAssessmentStrengths();">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.getElementById('strengthsContainer').appendChild(div);
            div.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', updateAssessmentStrengths);
            });
        });

        // Topics handling
        const topicsContainer = document.getElementById('topicsContainer');
        const topicsInput = topicsContainer.querySelector('.tag-input');
        const topicsHidden = document.querySelector('input[name="topics"]');
        let topics = ['AI', 'Machine Learning'];
        function updateTopics() {
            topicsHidden.value = topics.join('; ');
        }
        function createTag(text) {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.innerHTML = `
                ${text}
        <span class="remove-tag" onclick="removeTag(this)">&times;</span>
            `;
            return tag;
        }
        function removeTag(element) {
            const tag = element.parentElement;
            const text = tag.textContent.slice(0, -1).trim();
            topics = topics.filter(t => t !== text);
            tag.remove();
            updateTopics();
        }
        function renderTags() {
            topicsContainer.querySelectorAll('.tag').forEach(tag => tag.remove());
            topics.forEach(topic => {
                topicsContainer.insertBefore(createTag(topic), topicsInput);
            });
        }
        topicsInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.value.trim()) {
                e.preventDefault();
                const text = e.target.value.trim();
                if (!topics.includes(text)) {
                    topics.push(text);
                    topicsContainer.insertBefore(createTag(text), topicsInput);
                    updateTopics();
                }
                e.target.value = '';
            }
        });
        renderTags();

    // Fetch CSV data for courses
    const CSV_URL = 'https://raw.githubusercontent.com/IntegraceEvents/pathcompass-beta/refs/heads/main/database.csv';
    let coursesData = [];
    async function fetchCSVData() {
      try {
        const response = await fetch(CSV_URL);
        if (!response.ok) {
          throw new Error('Failed to fetch CSV data');
        }
        const csvText = await response.text();
        coursesData = parseCSV(csvText);
        console.log('Loaded courses:', coursesData);
      } catch (error) {
        console.error('Error loading CSV:', error);
        alert('Error loading course data. Please try again later.');
      }
    }
    fetchCSVData();
        document.getElementById('matchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
      if (coursesData.length === 0) {
        alert('Course data is not loaded yet. Please try again in a moment.');
                return;
            }
            const resultDiv = document.getElementById('result');
            const matchesContainer = document.querySelector('.course-matches');
            const preferences = {
        pass_rate: formData.get('pass_rate').toLowerCase(),
                assessment_ratio: formData.get('assessment_ratio'),
        num_assessments: parseInt(formData.get('num_assessments')),
                instructor_rating: formData.get('instructor_rating'),
                topics: formData.get('topics'),
                assessment_strengths: formData.get('assessment_strengths'),
        popularity: formData.get('popularity').toLowerCase(),
                gender_distribution: formData.get('gender_distribution'),
        care_pass_rate: (parseFloat(formData.get('care_pass_rate')) / 100).toFixed(2),
        care_assessment_ratio: (parseFloat(formData.get('care_assessment_ratio')) / 100).toFixed(2),
        care_num_assessments: (parseFloat(formData.get('care_num_assessments')) / 100).toFixed(2),
        care_instructor_rating: (parseFloat(formData.get('care_instructor_rating')) / 100).toFixed(2),
        care_topics: (parseFloat(formData.get('care_topics')) / 100).toFixed(2),
        care_assessment_strengths: (parseFloat(formData.get('care_assessment_strengths')) / 100).toFixed(2),
        care_popularity: (parseFloat(formData.get('care_popularity')) / 100).toFixed(2),
        care_gender_distribution: (parseFloat(formData.get('care_gender_distribution')) / 100).toFixed(2)
      };
      console.log('Processing data:', { courses: coursesData, preferences });
      try {
        const matchScores = coursesData.map(course => ({
          course,
          score: calculateMatchScore(course, preferences)
        }));


        
        
        matchScores.sort((a, b) => b.score - a.score);
        console.log('Calculated match scores:', matchScores);
                matchesContainer.innerHTML = '';
                matchScores.forEach(({ course, score }) => {
  // Store the course in the global map using its unique name.
  coursesMap[course['Course Name']] = course;
  
                    const card = document.createElement('div');
                    card.className = 'course-card';
                    card.innerHTML = `
                        <div class="course-header">
                        <h4>${course['Course Name']}</h4>
                            <div class="match-score">${score}%</div>
                        </div>
                        <div class="course-info">
                            <div>
                                <span class="label">Pass Rate:</span>
                                <span class="value">${course['Pass Rate']}%</span>
                            </div>
                            <div>
                                <span class="label">Instructor Rating:</span>
                                <span class="value">${course['Instructor Rating']}%</span>
                            </div>
                        </div>
                        <button type="button" class="course-details-btn" onclick="showCourseDetails('${course['Course Name']}')">
                            View Details
    </button>
    <button type="button" class="course-details-btn" onclick="getReasoningForCourse('${course['Course Name']}', ${score})">
      Reasoning
    </button>
    <button type="button" class="course-details-btn" onclick="askCourse('${course['Course Name']}', ${score})">
  Ask
                        </button>
                    `;
                    matchesContainer.appendChild(card);
                });
                
                resultDiv.style.display = 'block';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while calculating match scores.');
            }
        });
        function showCourseDetails(courseName) {
            console.log('Show details for:', courseName);
            const course = coursesMap[courseName];
            if (!course) return alert("Course details not found.");
            
            // Build HTML content for the modal using course details
            const modalBody = document.getElementById("courseDetailsModalBody");
            modalBody.innerHTML = `
                <div class="course-details-content">
                    <p><strong>Course Name:</strong> ${course["Course Name"]}</p>
                    <p><strong>Course Code:</strong> ${course["Course Code"] || "N/A"}</p>
                    <p><strong>Pass Rate:</strong> ${course["Pass Rate"]}%</p>
                    <p><strong>Instructor Rating:</strong> ${course["Instructor Rating"]}%</p>
                    <p><strong>Number of Assessments:</strong> ${course["Number of assessments"]}</p>
                    <p><strong>Assessment Distribution:</strong> ${course["Exam vs Individual Coursework vs Group Coursework"]}</p>
                    <p><strong>Popularity:</strong> ${course["Popularity"]}%</p>
                    <p><strong>Gender Distribution:</strong> ${course["Gender distribution"] || "N/A"}</p>
                    <p><strong>Topics of Interest:</strong> ${course["Topics of Interest"] || "N/A"}</p>
                </div>
            `;
            
            // Show the modal
            const detailsModal = new bootstrap.Modal(document.getElementById('courseDetailsModal'));
            detailsModal.show();
        }
    function parseCSV(csvText) {
      const results = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: true
      });
      return results.data;
    }
    function normalizeNumber(value) {
      if (typeof value === 'string') {
        value = value.trim().replace('%', '');
      }
      const num = parseFloat(value);
      return isNaN(num) ? 0.0 : num;
    }
    function makeNumberSmall(number, minNum, maxNum) {
      if (maxNum - minNum === 0) return 0;
      return (number - minNum) / (maxNum - minNum);
    }
    function calculateMatchScore(course, preferences) {
      let totalScore = 0;
      let totalWeight = 0;
      function addScore(weight, score) {
        if (weight > 0) {
          const clampedScore = Math.max(0, Math.min(1, score));
          totalScore += clampedScore * weight;
          totalWeight += weight;
        }
      }
      if (course['Pass Rate'] && preferences.pass_rate) {
        const coursePass = normalizeNumber(course['Pass Rate']);
        const userPass = preferences.pass_rate.toLowerCase();
        let passRateScore = 0;
        if (userPass === 'low') {
          passRateScore = 1 - makeNumberSmall(coursePass, 0, 100);
        } else if (userPass === 'medium') {
          passRateScore = 1 - Math.abs(makeNumberSmall(coursePass, 0, 100) - 0.5) * 2;
        } else if (userPass === 'high') {
          passRateScore = makeNumberSmall(coursePass, 0, 100);
        }
        addScore(parseFloat(preferences.care_pass_rate), passRateScore);
        console.log('Pass Rate:', { score: passRateScore, weight: preferences.care_pass_rate });
      }
      if (course['Exam vs Individual Coursework vs Group Coursework'] && preferences.assessment_ratio) {
        const courseRatios = course['Exam vs Individual Coursework vs Group Coursework'].split(':').map(x => parseFloat(x));
        const prefRatios = preferences.assessment_ratio.split(':').map(x => parseFloat(x));
        if (courseRatios.length === 3 && prefRatios.length === 3) {
          const diffSum = courseRatios.reduce((sum, curr, i) => sum + Math.abs(curr - prefRatios[i]), 0);
          const ratioScore = 1 - (diffSum / 2);
          addScore(parseFloat(preferences.care_assessment_ratio), ratioScore);
          console.log('Assessment Distribution:', { score: ratioScore, weight: preferences.care_assessment_ratio });
        }
      }
      if (course['Number of assessments'] && preferences.num_assessments) {
        const courseAssess = parseInt(course['Number of assessments']);
        const userAssess = parseInt(preferences.num_assessments);
        const diff = Math.abs(courseAssess - userAssess);
        const assessmentScore = 1 - Math.min(diff / 10, 1);
        addScore(parseFloat(preferences.care_num_assessments), assessmentScore);
        console.log('Number of Assessments:', { score: assessmentScore, weight: preferences.care_num_assessments });
      }
      if (course['Instructor Rating'] && preferences.instructor_rating) {
        const courseRating = normalizeNumber(course['Instructor Rating']);
        const userRatingStr = preferences.instructor_rating;
        let ratingScore = 0;
        if (userRatingStr.startsWith('>')) {
          const threshold = parseFloat(userRatingStr.slice(1));
          if (!isNaN(threshold)) {
            if (courseRating > threshold) {
              ratingScore = makeNumberSmall(courseRating, threshold, 100);
            }
          }
        } else if (!isNaN(parseFloat(userRatingStr))) {
          const userRating = parseFloat(userRatingStr);
          ratingScore = 1 - Math.abs(makeNumberSmall(courseRating, 0, 100) - makeNumberSmall(userRating, 0, 100));
        }
        addScore(parseFloat(preferences.care_instructor_rating), ratingScore);
        console.log('Instructor Rating:', { score: ratingScore, weight: preferences.care_instructor_rating });
      }
      if (course['Topics of Interest'] && preferences.topics) {
  const courseTopics = course['Topics of Interest'].split(';').map(t => t.trim().toLowerCase());
  const userTopics = preferences.topics.split(';').map(t => t.trim().toLowerCase());
  let maxScore = 0;
  userTopics.forEach(userTag => {
    courseTopics.forEach(courseTag => {
      if (courseTag === userTag) {
        maxScore = Math.max(maxScore, 1);
      } else {
        // Split each tag into words
        const userWords = userTag.split(' ');
        const courseWords = courseTag.split(' ');
        // Find common words
        const common = userWords.filter(word => courseWords.includes(word));
        // Use union of words to compute Jaccard similarity
        const union = new Set([...userWords, ...courseWords]);
        const similarity = union.size > 0 ? common.length / union.size : 0;
        maxScore = Math.max(maxScore, similarity);
      }
    });
  });
  addScore(parseFloat(preferences.care_topics), maxScore);
  console.log('Topics:', { score: maxScore, weight: preferences.care_topics });
}
      if (course['Popularity'] && preferences.popularity) {
        const coursePopularity = normalizeNumber(course['Popularity']);
        const userPopularity = preferences.popularity.toLowerCase();
        let popularityScore = 0;
        if (userPopularity === 'low') {
          popularityScore = 1 - makeNumberSmall(coursePopularity, 0, 100);
        } else if (userPopularity === 'medium') {
          popularityScore = 1 - Math.abs(makeNumberSmall(coursePopularity, 0, 100) - 0.5) * 2;
        } else if (userPopularity === 'high') {
          popularityScore = makeNumberSmall(coursePopularity, 0, 100);
        }
        addScore(parseFloat(preferences.care_popularity), popularityScore);
        console.log('Popularity:', { score: popularityScore, weight: preferences.care_popularity });
      }
      if (course['Gender distribution'] && preferences.gender_distribution) {
        const userGenderStr = preferences.gender_distribution.toLowerCase();
        let genderScore = 0;
        if (userGenderStr === "don't care") {
          genderScore = 1.0;
        } else if (userGenderStr.includes(':')) {
          const courseDist = course['Gender distribution'].split(':').map(x => parseFloat(x));
          const userDist = preferences.gender_distribution.split(':').map(x => parseFloat(x));
          if (courseDist.length === 2 && userDist.length === 2) {
            const diff = Math.abs(courseDist[0] - userDist[0]) + Math.abs(courseDist[1] - userDist[1]);
            genderScore = 1 - (diff / 100);
          }
        }
        addScore(parseFloat(preferences.care_gender_distribution), genderScore);
        console.log('Gender Distribution:', { score: genderScore, weight: preferences.care_gender_distribution });
      }
      if (totalWeight > 0) {
        const finalScore = (totalScore / totalWeight) * 100;
        console.log('Final Score:', { totalScore, totalWeight, finalScore });
        return Math.round(finalScore);
      }
      return 0;
    }

    // ---------------- Gemini API Integration ----------------
    document.getElementById("geminiSend").addEventListener("click", async () => {
        const userInput = document.getElementById("geminiInput").value.trim();
        if (!userInput) {
          return alert("Please enter your course preference.");
        }
        lastUserInput = userInput; // Save the user's input for later reasoning prompts.
        
        const geminiPrompt = `
      You are an intelligent configuration assistant for a Course Match Calculator. You will receive a natural language input describing a user's course preferences. Based on the input, decide on the values for all of the following parameters and assign a corresponding weighting (0–100) that indicates how important that parameter is for matching courses. Only output parameters you consider relevant; any parameter omitted is considered not relevant (and its weighting will default to 0).
      
      Output your answer in exactly the JSON format below (with no extra text or formatting):
      
      {
        "pass_rate": "<Low|Medium|High>",
        "care_pass_rate": <0-100>,
        "assessment_ratio": "<exam:individual:group>",
        "care_assessment_ratio": <0-100>,
        "num_assessments": <number>,
        "care_num_assessments": <0-100>,
        "instructor_rating": <0-100>,
        "care_instructor_rating": <0-100>,
        "topics": [ "<topic1>", "<topic2>", ... ],
        "care_topics": <0-100>,
        "assessment_strengths": { "<type>": <0-1>, ... },
        "care_assessment_strengths": <0-100>,
        "popularity": "<Low|Medium|High>",
        "care_popularity": <0-100>,
        "gender_distribution": "<male:female>",
        "care_gender_distribution": <0-100>
      }
      
      For example, if the user says:
      "I just want to pass. I prefer courses with high pass rates and very few assessments, and I don't care about topics or instructor quality."
      Your output should be:
      
      {
        "pass_rate": "High",
        "care_pass_rate": 100,
        "num_assessments": 3,
        "care_num_assessments": 100,
        "assessment_ratio": "0.6:0.3:0.1",
        "care_assessment_ratio": 0,
        "instructor_rating": 0,
        "care_instructor_rating": 0,
        "topics": [],
        "care_topics": 0,
        "assessment_strengths": {},
        "care_assessment_strengths": 0,
        "popularity": "Medium",
        "care_popularity": 0,
        "gender_distribution": "50:50",
        "care_gender_distribution": 0
      }
      
      User Input: "${userInput}"
      `;
      
        try {
          const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + GEMINI_API_KEY, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: geminiPrompt }]
              }]
            })
          });
      
          if (!response.ok) {
            throw new Error("Gemini API request failed with status " + response.status);
          }
      
          const data = await response.json();
          console.log("Gemini response data:", data);
      
          let outputText = "";
          if (data && data.candidates && data.candidates.length > 0) {
            outputText = data.candidates[0].content.parts[0].text || "";
          } else {
            throw new Error("Unexpected response format from Gemini API.");
          }
          console.log("Output text:", outputText);
      
          // Extract JSON between markdown fences.
          const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
          const match = outputText.match(jsonRegex);
          if (!match || !match[1]) {
            throw new Error("JSON object not found in Gemini response");
          }
          const result = JSON.parse(match[1]);
          console.log("Parsed Gemini JSON:", result);
      
          // List of expected parameters
          const parameters = [
            { field: "pass_rate", care: "care_pass_rate", type: "select" },
            { field: "assessment_ratio", care: "care_assessment_ratio", type: "ratio" },
            { field: "num_assessments", care: "care_num_assessments", type: "number" },
            { field: "instructor_rating", care: "care_instructor_rating", type: "number" },
            { field: "topics", care: "care_topics", type: "tags" },
            { field: "assessment_strengths", care: "care_assessment_strengths", type: "object" },
            { field: "popularity", care: "care_popularity", type: "select" },
            { field: "gender_distribution", care: "care_gender_distribution", type: "ratioString" }
          ];
      
          parameters.forEach(param => {
            if (result.hasOwnProperty(param.field)) {
              switch(param.type) {
                case "select":
                case "number":
                  document.querySelector(`[name="${param.field}"]`).value = result[param.field];
                  break;
                case "ratio":
                case "ratioString":
                  document.querySelector(`[name="${param.field}"]`).value = result[param.field];
                  break;
                case "tags":
                  const topicsContainer = document.getElementById("topicsContainer");
                  const topicsInput = topicsContainer.querySelector(".tag-input");
                  topicsContainer.querySelectorAll('.tag').forEach(tag => tag.remove());
                  if (Array.isArray(result.topics)) {
                    result.topics.forEach(topic => {
                      const tag = document.createElement("span");
                      tag.className = "tag";
                      tag.innerHTML = `${topic} <span class="remove-tag" onclick="removeTag(this)">&times;</span>`;
                      topicsContainer.insertBefore(tag, topicsInput);
                    });
                  }
                  document.querySelector('input[name="topics"]').value = Array.isArray(result.topics) ? result.topics.join("; ") : "";
                  break;
                case "object":
                  let strengthsArray = [];
                  for (const key in result.assessment_strengths) {
                    if (result.assessment_strengths.hasOwnProperty(key)) {
                      strengthsArray.push(`${key}:${parseFloat(result.assessment_strengths[key]).toFixed(1)}`);
                    }
                  }
                  document.querySelector('input[name="assessment_strengths"]').value = strengthsArray.join(",");
                  break;
              }
              if (typeof result[param.care] !== "undefined") {
                const slider = document.querySelector(`input[name="${param.care}"]`);
                slider.value = result[param.care];
                slider.parentNode.querySelector(".importance-value").textContent = result[param.care] + "%";
              }
            } else {
              const slider = document.querySelector(`input[name="${param.care}"]`);
              if (slider) {
                slider.value = 0;
                slider.parentNode.querySelector(".importance-value").textContent = "0%";
              }
            }
          });
          
          alert("Preferences updated based on your input!");
        } catch (error) {
          console.error("Error:", error);
          alert("Error setting preferences: " + error.message);
        }
      });

      // New function: getReasoningForCourse with updated prompt and modal display
      async function getReasoningForCourse(courseName, score) {
        const course = coursesMap[courseName];
        if (!course) return alert("Course details not found.");
        
        // Revised, concise and human-friendly reasoning prompt.
        const reasoningPrompt = `
    User input: "${lastUserInput}"
    Course: ${course["Course Name"]}
    Pass Rate: ${course["Pass Rate"]}%
    Instructor Rating: ${course["Instructor Rating"]}%
    Assessments: ${course["Number of assessments"]} (Distribution: ${course["Exam vs Individual Coursework vs Group Coursework"]})
    Popularity: ${course["Popularity"]}%
    
    In simple, clear language, briefly explain why this course is a good match for the user.
    `;
        
        try {
          const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + GEMINI_API_KEY, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: reasoningPrompt }]
              }]
            })
          });
          if (!response.ok) {
            throw new Error("Gemini API request failed with status " + response.status);
          }
          const data = await response.json();
          let outputText = "";
          if (data && data.candidates && data.candidates.length > 0) {
            outputText = data.candidates[0].content.parts[0].text || "";
          } else {
            throw new Error("Unexpected response format from Gemini API.");
          }
          // Remove markdown fences if present.
          const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
          const match = outputText.match(jsonRegex);
          let reasoningOutput = "";
          if (match && match[1]) {
            reasoningOutput = match[1];
          } else {
            reasoningOutput = outputText;
          }
          
          // Build HTML content for the modal using course details and the reasoning output.
          const modalBody = document.getElementById("reasoningModalBody");
          modalBody.innerHTML = `
            <p><strong>Course:</strong> ${course["Course Name"]}</p>
            <p><strong>Pass Rate:</strong> ${course["Pass Rate"]}%</p>
            <p><strong>Instructor Rating:</strong> ${course["Instructor Rating"]}%</p>
            <p><strong>Assessments:</strong> ${course["Number of assessments"]} (Distribution: ${course["Exam vs Individual Coursework vs Group Coursework"]})</p>
            <p><strong>Popularity:</strong> ${course["Popularity"]}%</p>
            <hr>
            <p>${reasoningOutput}</p>
          `;
          
          // Show the modal (using Bootstrap's modal API)
          const reasoningModal = new bootstrap.Modal(document.getElementById('reasoningModal'));
          reasoningModal.show();
        } catch (error) {
          console.error("Error retrieving reasoning:", error);
          alert("Error retrieving reasoning: " + error.message);
        }
      }

      // New function: askCourse – handles the "Ask" feature.
  async function askCourse(courseName, score) {
    const course = coursesMap[courseName];
    if (!course) return alert("Course details not found.");
    
    const courseCode = course["Course Code"];
    if (!courseCode) return alert("Course code not found for this course.");
    const url = `http://www.drps.ed.ac.uk/24-25/dpt/cx${courseCode.toLowerCase()}.htm`;
    
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error("Failed to fetch course website with status " + response.status);
      }
      const sourceText = await response.text();
      // Populate Ask modal with course details and an excerpt of the website source.
      document.getElementById("askCourseDetails").innerHTML = `
        <p><strong>Course:</strong> ${course["Course Name"]}</p>
        <p><strong>Pass Rate:</strong> ${course["Pass Rate"]}%</p>
        <p><strong>Instructor Rating:</strong> ${course["Instructor Rating"]}%</p>
        <p><strong>Course Code:</strong> ${courseCode}</p>
      `;
      // Clear any previous question and answer.
      document.getElementById("askUserQuestion").value = "";
      document.getElementById("askModalBody").querySelectorAll("hr, p.answer").forEach(el => el.remove());
      
      // Show Ask modal.
      const askModal = new bootstrap.Modal(document.getElementById("askModal"));
      askModal.show();
      
      // Set up the send button handler.
      document.getElementById("askSendButton").onclick = async function() {
        const userQuestion = document.getElementById("askUserQuestion").value.trim();
        if (!userQuestion) {
          return alert("Please enter your question.");
        }
        const askGeminiPrompt = `
User question: "${userQuestion}"
Course details:
Course: ${course["Course Name"]}
Pass Rate: ${course["Pass Rate"]}%
Instructor Rating: ${course["Instructor Rating"]}%
Course Code: ${courseCode}
Website content (excerpt): ${sourceText}...
If you cannot find specific information, advise the user to email the course organiser or school for further details.
Provide a concise, human-friendly answer in simple language.
`;
        try {
          const geminiResponse = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + GEMINI_API_KEY, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: askGeminiPrompt }]
              }]
            })
          });
          if (!geminiResponse.ok) {
            throw new Error("Gemini API request failed with status " + geminiResponse.status);
          }
          const geminiData = await geminiResponse.json();
          let geminiOutput = "";
          if (geminiData && geminiData.candidates && geminiData.candidates.length > 0) {
            geminiOutput = geminiData.candidates[0].content.parts[0].text || "";
          } else {
            throw new Error("Unexpected response format from Gemini API.");
          }
          const outputRegex = /```json\s*([\s\S]*?)\s*```/;
          const m = geminiOutput.match(outputRegex);
          let finalAnswer = "";
          if (m && m[1]) {
            finalAnswer = m[1];
          } else {
            finalAnswer = geminiOutput;
          }
          // Convert markdown formatting for newlines and bold.
          finalAnswer = finalAnswer.replace(/\n/g, "<br>").replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
          const modalBody = document.getElementById("askModalBody");
          const hr = document.createElement("hr");
          const answerPara = document.createElement("p");
          answerPara.className = "answer";
          answerPara.innerHTML = `<strong>Answer:</strong> ${finalAnswer}`;
          modalBody.appendChild(hr);
          modalBody.appendChild(answerPara);
        } catch (error) {
          console.error("Error retrieving answer:", error);
          alert("Error retrieving answer: " + error.message);
        }
      };
      
    } catch (error) {
      console.error("Error fetching course website:", error);
      alert("Error fetching course website: " + error.message);
    }
  }

    // ---------------- End Gemini Integration ----------------
    </script>

  <!-- Reasoning Modal -->
<div class="modal fade" id="reasoningModal" tabindex="-1" aria-labelledby="reasoningModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reasoningModalLabel">Course Reasoning</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="reasoningModalBody">
        <!-- Reasoning text and course details will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Course Details Modal -->
<div class="modal fade" id="courseDetailsModal" tabindex="-1" aria-labelledby="courseDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courseDetailsModalLabel">Course Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="courseDetailsModalBody">
        <!-- Course details will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Ask Modal -->
<div class="modal fade" id="askModal" tabindex="-1" aria-labelledby="askModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="askModalLabel">Ask About Course</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="askModalBody">
        <!-- Course details, website source excerpt and chat field will be inserted here -->
        <div id="askCourseDetails"></div>
        <hr>
        <textarea id="askUserQuestion" class="form-control" placeholder="Type your question here..."></textarea>
      </div>
    <div class="modal-footer" style="display: flex; justify-content: flex-end; align-items: center;">
  <button type="button" id="askSendButton" class="btn btn-primary"
          style="min-height: 38px; display: flex; align-items: center; justify-content: center; padding: 0.375rem 0.75rem; border-radius: 0.375rem; margin-right: 0.5rem; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border: none; box-shadow: 0 4px 15px rgba(123, 44, 191, 0.2); margin-top: 0;">
    Send
  </button>
  <button type="button" id="askCloseButton" class="btn btn-secondary" data-bs-dismiss="modal"
          style="min-height: 38px; display: flex; align-items: center; justify-content: center; padding: 0.375rem 0.75rem; border-radius: 0.375rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);">
    Close
  </button>
</div>
      </div>
    </div>
  </div>
</div>


</body>
</html> 
